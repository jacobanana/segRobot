<html>
  <head>

  <!-- bootstrap css -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <!-- fontawesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- dot matrix css -->
  <style>
    .matrix{
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background-color: #000000;
      padding: 35px 0;
    }
    .matrixRow {
      background-color: #000000;
      display: flex;
      margin: auto;
      align-items: baseline;
    }
    .dot {
      height: 50px;
      width: 50px;
      border-radius: 50%;
      display: inline-block;
      margin: 2px;
      background-color: #303030;
    }
    .red {
      background-color: #FF0000;
    }

    .dotone {
      border: solid 6px blue;
    }

    .options {
      padding: 10px;
      text-align: center;
    }

    pre {
      background-color: #C0C0C0;
      border: solid 2px black;
      padding: 10px;
    }
  </style>

  <!-- jQuery & bootstrap javascript -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <!-- mousetrap for shortcuts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.2/mousetrap.min.js"></script>

  </head>

  <body>


    <div class="container">
      <header>
        <h1>Dot Matrix Designer</h1>
      </header>
      <main>
        <div class="row">

          <div class="content col-lg-6">

            <div class="input-group input-group-sm mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">0x</span>
              </div>
              <input type="text" class="form-control" id="hex">
            </div>

            <div class="matrix" id="main">
              <div class="matrixRow" row="0">
                <span class="dot dotone" col="0" id="0-deg"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7" id="90-deg"></span>
              </div>

              <div class="matrixRow" row="1">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="2">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="3">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="4">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="5">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="6">
                <span class="dot" col="0"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7"></span>
              </div>

              <div class="matrixRow" row="7">
                <span class="dot" col="0" id="270-deg"></span>
                <span class="dot" col="1"></span>
                <span class="dot" col="2"></span>
                <span class="dot" col="3"></span>
                <span class="dot" col="4"></span>
                <span class="dot" col="5"></span>
                <span class="dot" col="6"></span>
                <span class="dot" col="7" id="180-deg"></span>
              </div>

            </div>

            <div class="row">

              <div class="options col-8">
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="invert" data-toggle="tooltip" data-placement="bottom" title="Invert pattern [i]"><i class="fas fa-adjust"></i></button>
                </div>
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="clear" data-toggle="tooltip" data-placement="bottom" title="Clear [escape]"><i class="fas fa-times"></i></button>
                </div>
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="shiftUp" data-toggle="tooltip" data-placement="bottom" title="Shift Up [up]"><i class="fas fa-angle-double-up"></i></button>
                </div>
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="shiftDown" data-toggle="tooltip" data-placement="bottom" title="Shift Down [down]"><i class="fas fa-angle-double-down"></i></button>
                </div>
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="shiftLeft" data-toggle="tooltip" data-placement="bottom" title="Shift Left [left]"><i class="fas fa-angle-double-left"></i></button>
                </div>
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-primary" id="shiftRight" data-toggle="tooltip" data-placement="bottom" title="Shift Right [right]"><i class="fas fa-angle-double-right"></i></button>
                </div>
              </div>

              <div class="options col-4">
                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-success" id="save" data-toggle="tooltip" data-placement="bottom" title="Duplicate [enter]"><i class="far fa-copy"></i></button>
                </div>

                <div class="form-check form-check-inline">
                  <button class="btn btn-sm btn-danger" id="delete" data-toggle="tooltip" data-placement="bottom" title="Delete [backspace / delete]"><i class="far fa-trash-alt"></i></button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div>
              <h4>Export options</h4>
              <div class="form-check form-check-inline">
                <select class="custom-select custom-select-sm" id="orientation" data-toggle="tooltip" data-placement="bottom" title="Display orientation, the blue dot is LED 0,0 [r]">
                  <option value="0-deg" selected>0 degree</option>
                  <option value="90-deg">90 degree</option>
                  <option value="180-deg">180 degree</option>
                  <option value="270-deg">270 degree</option>
                </select>
              </div>

              <div class="form-check form-check-inline">
                <select class="custom-select custom-select-sm" id="format" data-toggle="tooltip" data-placement="bottom" title="Data format for code output [f]">
                  <option value="uint64_t" selected>uint64_t</option>
                  <option value="byte">byte array</option>
                </select>
              </div>

              <div class="form-check form-check-inline">
                <input class="form-control form-control-sm" id="variable" value="IMAGES" data-toggle="tooltip" data-placement="bottom" title="Variable name for code output"/>
              </div>
            </div>
            <hr/>
            <div>
              <h4>Code Snippet</h4>
              <pre><code class="pattern" id="code"></code></pre>
            </div>
          </div>
        </div>

      </main>
    </div>

    <script>
    let savedPatterns = [];
    let workingPattern = 0;

    $(() => {
      $('[data-toggle="tooltip"]').tooltip()
      updatePattern();

      // detect whether the mouse is clicked or not
      let down = false;
      $(document).mousedown(() => {
          down = true;
      }).mouseup(() => {
          down = false;
      });

      $(".dot").on('pointerdown', (event) => {
        $(event.currentTarget).toggleClass("red");
        updatePattern();
      }).on('pointerenter', (event) => {
        if(down === true){
          $(event.currentTarget).toggleClass("red");
          updatePattern();
        }
      })

      $("#orientation").change(() => {
        changeOrientation();
      })
      $("#hex").change(() => {
        loadPattern(reversePattern("0x"+$("#hex").val()))
        updatePattern();
      })
      $("select, input").change(() => {
        updatePattern();
      })


      // Buttons
      $("#invert").click(() => { invertPattern(); })
      $("#clear").click(() => { clearPattern(); })
      $("#shiftUp").click(() => { shiftUp(); })
      $("#shiftDown").click(() => { shiftDown(); })
      $("#shiftLeft").click(() => { shiftLeft(); })
      $("#shiftRight").click(() => { shiftRight(); })
      $("#save").click(() => { savePattern(); })
      $("#delete").click(() => { deletePattern(); })

      // Shortcuts
      Mousetrap.bind('i', () => { invertPattern(); })
      Mousetrap.bind('esc', () => { clearPattern(); })
      Mousetrap.bind('up', () => { shiftUp(); })
      Mousetrap.bind('down', () => { shiftDown(); })
      Mousetrap.bind('left', () => { shiftLeft(); })
      Mousetrap.bind('right', () => { shiftRight(); })
      Mousetrap.bind('r', () => {
        toggleOption('#orientation');
        changeOrientation();
      })
      Mousetrap.bind('f', () => {
        toggleOption('#format');
        updatePattern();
      })
      Mousetrap.bind('enter', () => { savePattern(); })
      Mousetrap.bind('backspace', () => { deletePattern(); })
    });

    var toggleOption = (search) => {
      if($(`${search} option:selected`).val() == $(`${search} option`).last().val()){
          $(`${search} option`).attr('selected', false).first().attr('selected', true);
      } else {
        $(`${search} option:selected`).attr('selected', false).next().attr('selected', true);
      }
    }

    var rotate90 = (matrix) => {
      let m = JSON.parse(JSON.stringify(matrix));
      // swap the symmetric elements
      for (var i = 0; i < m.length; i++) {
        for (var j = 0; j < i; j++) {
          var temp = m[i][j];
          m[i][j] = m[j][i];
          m[j][i] = temp;
        }
      }
      return m;
    };

    var rotate180 = (matrix) => {
      let m = matrix.map(row => { row.reverse(); return row; })
      return m;
    }

    var rotate270 = (matrix) => {
      let m;
      m = rotate180(matrix);
      m = m.reverse();
      m = rotate90(m);
      return m;
    };

    var buildPattern = () => {
      let pattern = [];
      let line = [];
      $(".dot").each((i, e) => {
        let status = $(e).hasClass("red") ? 1 : 0;
        line.push(status);
        if (line.length == 8){
          pattern.push(line);
          line = [];
        }
      })
      return pattern;
    }

    var updatePattern = (index) => {
      let orientation = $("#orientation").val();
      let format = $("#format").val();
      let variable = $("#variable").val() || "IMAGES";
      let pattern = buildPattern();
      let codeOutput;
      index = index || workingPattern;
      savedPatterns[index] = pattern;

      if (format == "byte"){
        codeOutput = `const byte ${variable}[]`;
        codeOutput += ` = {${formatByte(rotatePattern(pattern, orientation))}};`;

      } else if (format == "uint64_t") {
        codeOutput = `const uint64_t ${variable}[] = {\n`;
        let listPatterns = JSON.parse(JSON.stringify(savedPatterns));
        //listPatterns[index] = pattern;
        listPatterns = listPatterns.map((p, i) => {
          p = formatUint64_t(rotatePattern(p, orientation))
          if(i!=workingPattern){
              p = `    <a href="#" class="badge badge-light recall" index="${i}">${p}</a>`
          } else {
              $("#hex").val(p.substring(2, p.length))
              p = `    <a href="#" class="badge badge-dark recall" index="${i}">${p}</a>`

          }
          return p;
        });
        codeOutput += `${listPatterns.join(", \n")}\n};`;
      }

      $(".pattern").html(codeOutput);
      $(".recall").click(e => {
        let p = reversePattern($(e.currentTarget).text());
        workingPattern = $(e.currentTarget).attr("index")
        loadPattern(p);
      })
    }

    var rotatePattern = (pattern, orientation) => {
      let p;
      if(orientation == "90-deg"){
        p = rotate90(pattern);
      } else if(orientation == "180-deg"){
        p = rotate180(pattern);
      } else if(orientation == "270-deg"){
        p = rotate270(pattern);
      } else {
        p = pattern.reverse();
      }
      return p;
    }

    var formatUint64_t = (pattern) =>{
      pattern = pattern.map(row => {
        return parseInt(row.join(""), 2).toString(16).padStart(2, '0');
      });
      pattern = "0x"+pattern.join("");
      return pattern;
    }

    var formatByte = (pattern) => {
      pattern = pattern.map(row => {
        return "B"+row.join("")
      });
      return pattern;
    }


    var invertPattern = () => {
      $(".dot").toggleClass("red");
      updatePattern();
    }

    var clearPattern = () => {
      $(".red").removeClass("red");
      updatePattern();
    }

    var loadPattern = (pattern, target, index) => {
      target = target || "#main";
      index = index || workingPattern;
      clearPattern();
      for (i = 0; i<8; i++){
        for(j=0; j<8; j++){
          if (pattern[i][j] == 1){
            $(`${target} > [row=${i}] > [col=${j}]`).addClass("red");
          }
        }
      }
      updatePattern(index);
    }

    var shiftUp = (pattern) => {
      pattern = pattern || buildPattern();
      let newPattern = []
      for(i=0; i<7; i++){
        newPattern.push(pattern[i+1])
      }
      newPattern.push([0,0,0,0,0,0,0,0]);
      loadPattern(newPattern);
      return newPattern;
    }

    var shiftDown = (pattern) => {
      pattern = pattern || buildPattern();
      let newPattern = [[0,0,0,0,0,0,0,0]]
      for(i=0; i<7; i++){
        newPattern.push(pattern[i])
      }
      loadPattern(newPattern);
      return newPattern;
    }

    var shiftLeft = (pattern) => {
      pattern = pattern || buildPattern();
      pattern = rotate90(pattern);
      pattern = shiftUp(pattern);
      pattern = rotate90(pattern);
      loadPattern(pattern)
      return pattern;
    }

    var shiftRight = (pattern) => {
      pattern = pattern || buildPattern();
      pattern = rotate90(pattern);
      pattern = shiftDown(pattern);
      pattern = rotate90(pattern);
      loadPattern(pattern)
      return pattern;
    }

    var changeOrientation = () => {
      $(".dotone").removeClass("dotone");
      let value = $("#orientation").val();
      $("#"+value).addClass("dotone");
      updatePattern();
    }

    var savePattern = (pattern) => {
      pattern = pattern || buildPattern();
      workingPattern = savedPatterns.length
      updatePattern();
    }

    var deletePattern = () => {
      if(savedPatterns.length > 0){
        savedPatterns.splice(workingPattern, 1)
        workingPattern = workingPattern >= savedPatterns.length ? savedPatterns.length-1 : workingPattern;
        if(savedPatterns.length == 0){
          clearPattern();
          savePattern();
        }
        loadPattern(savedPatterns[workingPattern]);
      }
    }

    var reversePattern = (pattern) => {
      let newPattern = [];
      for(i=8;i>0;i--){
        let chunk = parseInt(pattern.substring(i*2, i*2+2), 16)
                    .toString(2)
                    .padStart(8, 0)
                    .split("");
        newPattern.push(chunk);
      }
      return newPattern;
    }
    </script>

  </body>
</html>
